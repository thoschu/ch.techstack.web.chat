<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Tom´s Socket.IO CHAT</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: 'Droid Sans Mono', monospace;
            }

            body {
                font: 13px Helvetica, Arial;
            }

            .container {
                width: 50vw !important;
                margin: 0;
                padding: 0;
            }

            header {
                position: sticky;
                top: 0;
                background-color: white;
                z-index: 10000000;
            }

            main, footer {
                position: fixed;
                width: inherit;
            }

            main {
                top: 300px;
                height: calc(100vh - 43%);
                overflow-y: scroll;
            }

            footer {
                bottom: 10px;
                background-color: white;
                z-index: 10000000;
            }

            form {
                background: white;
                padding: 3px;
                position: fixed;
                bottom: 0;
                width: 100%;
            }

            form input {
                border: 1px solid #c3c3c3;
                padding: 10px;
                width: 100%;
                margin-right: 0;
            }

            form button {
                border: 1px solid #c3c3c3;
                width: 100%;
                border-radius: 2px;
                margin-top: 5px;
                padding: 10px 0;
            }

            #messages {
                list-style-type: none;
                margin: 0;
                padding: 0;
            }

            #messages li {
                padding: 5px 10px;
            }

            #messages li:nth-child(odd) {
                background: #c3c3c3;
            }

            #chatcanvas {
                width: 100%;
                height: 50px;
                border: dotted #c3c3c3 1px;
            }

            li.info-text {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            li.text-message {
                min-height: 50px;
            }

            li:nth-child(odd) {
                border-right: 7px solid #c3c3c3;
            }

            li:nth-child(4n+1), li:nth-child(4n+2) {
                border-left: 7px solid #eaeaea;
                background-color: #eaeaea;
            }

            li:nth-child(4n+3), li:nth-child(4n+4) {
                border-left: 7px solid #d7d7d7;
                background-color: #d7d7d7;
            }

            li[data-user-id]::after {
                content: " " attr(data-user-id) " ";
                margin-left: 5px;
                font-weight: bold;
                font-variant-caps: normal;
            }

            li:not(:first-child)[data-user-id]::after {
                animation: changeColor 3s linear forwards;
            }

            li:not(:first-child)[data-user-id]:hover::after {
                color: grey !important;
            }

            div.popup  {
                z-index: 1000000000;
            }

            @keyframes changeColor {
                0% {
                    content: " " attr(data-user-id) " ";
                    color: inherit;
                }
                50% {
                    content: " " attr(data-user-id) " ";
                    color: transparent;
                }
                100% {
                    content: " " attr(data-user-id) " ";
                    color: darkgrey;
                }
            }

            .jq-toast-wrap {
                min-width: 18vw;
            }

            @media screen and (max-width: 1400px) {
                video {
                    width: 100%;
                    height: auto;
                }

                div.iziToast {
                    width: 280px;
                }
            }

            @media screen and (max-width: 1200px) {
                div.iziToast, div.jq-toast-wrap {
                    display: none;
                }
            }
        </style>
        <link rel="icon" href="//cdn1.iconfinder.com/data/icons/freeline/32/bubble_chat_comment_message_outline_talk-32.png" type="image/x-icon">
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Droid+Sans+Mono">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.css" integrity="sha512-wJgJNTBBkLit7ymC6vvzM1EcSWeM9mmOu+1USHaRBbHkm6W9EgM0HY27+UtUaprntaYQJF75rc8gjxllKs5OIQ==" crossorigin="anonymous" referrerpolicy="no-referrer">
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" integrity="sha512-c42qTSw/wPZ3/5LBzD+Bw5f7bSF2oxou6wEb+I/lqeaKV5FDIfMvvRp772y4jcJLKuGUOpbJMdg/BTl50fJYAw==" crossorigin="anonymous" referrerpolicy="no-referrer">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
        <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/izitoast@1.4.0/dist/css/iziToast.min.css">
        <!--[if lt IE 9]>
            <script src="//oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
            <script src="//oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
        <!--
        <script>
            var _paq = window._paq = window._paq || [];
            _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
            _paq.push(["setCookieDomain", "*.techstack.ch"]);
            _paq.push(['trackPageView']);
            _paq.push(['enableLinkTracking']);
            (function () {
                var u = "//analytics.thomas-schulte.de/";
                _paq.push(['setTrackerUrl', u + 'matomo.php']);
                _paq.push(['setSiteId', '2']);
                var d = document, g = d.createElement('script'), s = d.getElementsByTagName('script')[0];
                g.async = true;
                g.src = u + 'matomo.js';
                s.parentNode.insertBefore(g, s);
            })();
        </script>
        <noscript>
            <p>
                <img referrerpolicy="no-referrer-when-downgrade" src="//analytics.thomas-schulte.de/matomo.php?idsite=2&amp;rec=1" style="border:0;" alt="">
            </p>
        </noscript>
        -->
    </head>
    <body class="container">
        <header class="row">
            <h2 class="col-md-12 text-center animate__animated animate__lightSpeedInRight">Moin …</h2>
            <h3 id="moin" class="col-md-12 text-center animate__animated animate__lightSpeedInLeft animate__delay-1s">∘techstack.ch∘</h3>
            <div class="col-md-12 animate__animated animate__fadeInDown animate__delay-2s animate__slow">
                <canvas id="chatcanvas"></canvas>
            </div>
            <form class="col-md-12 animate__animated animate__fadeInUp animate__delay-3s animate__slower">
                <label for="m"></label>
                <input id="m" placeholder="Hier tippen..." autocomplete="off">
                <button id="send_button" class="center-block" type="button" disabled>
                    <i class="fa fa-comments-o fa-lg" aria-hidden="true"></i>
                </button>
            </form>
        </header>
        <main class="row">
            <div class="col-md-12">
                <ul id="messages"></ul>
            </div>
        </main>
        <footer class="row animate__animated animate__bounceIn animate__delay-4s">
            <h6 class="col-md-12 text-center">&copy; by Tom S. - 2 0 2 4</h6>
        </footer>
        <script src="//use.fontawesome.com/1c70b6a09c.js" type="text/javascript" crossorigin="anonymous"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.js" integrity="sha512-Y+cHVeYzi7pamIOGBwYHrynWWTKImI9G78i53+azDb1uPmU1Dz9/r2BLxGXWgOC7FhwAGsy3/9YpNYaoBy7Kzg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <script src="//cdn.jsdelivr.net/npm/izitoast@1.4.0/dist/js/iziToast.min.js"></script>
        <script src="//cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.min.js"></script>
        <script src="//cdn.jsdelivr.net/npm/@simondmc/popup-js@1.4.2/popup.min.js"></script>
        <script type="importmap">
            {
                "imports": {
                    "lodash": "//cdn.jsdelivr.net/npm/lodash@4.17.21/+esm",
                    "socket.io-client": "//cdn.socket.io/4.7.2/socket.io.esm.min.js",
                    "rxjs": "//cdn.jsdelivr.net/npm/rxjs@7.8.1/+esm",
                    "rxjs/webSocket": "//esm.run/rxjs/webSocket"
                }
            }
        </script>
        <script src="/socket.io/socket.io.js"></script>
        <script type="module">
            // import { io } from 'socket.io-client';
            // import _ from 'lodash';
            // import { filter, from, map, tap } from 'rxjs';
            // import { webSocket }  from 'rxjs/webSocket';
            //
            // const list$ = from([1,2,3,4,5,6]).pipe(filter(x => x > 3), map(x => x * x));
            //
            // list$.subscribe((res) => {
            //     console.log(_.multiply(res, 100));
            // });
            //
            // const subject = webSocket('ws://localhost:3030');
            //
            // subject.subscribe({
            //     next: msg => console.dir(msg),
            //     error: err => console.log(err),
            //     complete: () => console.log('complete')
            // });
            //
            // subject.next({ message: 'some message message-including' });
            // subject.next({ message: 'some message message-excluding' });
            //
            // let workerSource = document.querySelector("script#worker");
            // let workerBlob = new Blob([workerSource.text], { type: "application/javascript" });
            // let workerUrl = URL.createObjectURL(workerBlob);
            // let webWorker = new Worker(workerUrl);
            // URL.revokeObjectURL(workerUrl)
            //
            // webWorker.addEventListener("message", function(messageEvent) {
            //     console.log("Der Wörker sagt: " + messageEvent.data);
            // });
            //
            const worker = new Worker ('../assets/web-worker.js');
            const element = document.getElementById('moin');
            const canvas = document.getElementById('chatcanvas');
            const button = document.getElementById('send_button');
            const input = document.getElementById('m');
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            const recordedBlobs = [];
            let context = canvas.getContext('2d');
            let connected = false;
            let counter = 0;
            let toast;
            let mediaRecorder;
            let W, H;

            W = canvas.width = window.innerWidth;
            H = canvas.height = window.innerHeight;

            context.font = '200px "Droid Sans Mono"';

            console.info(userAgent);

            const sound = new Howl({
                src: ['../assets/ui-confirm.flac'],
            });

            let socket = io({
                auth: {
                    token: "123456"
                }
            });

            button.addEventListener('touchstart', (event) => {
                event.preventDefault();

                const input = $('#m');

                socket.emit('chat message', input.val());

                input.val('');

                button.disabled = true;

                element.classList.remove('animate__lightSpeedInLeft');
                element.classList.remove('animate__pulse', 'animate__infinite', 'animate__slow')
                element.classList.add('animate__pulse', 'animate__infinite', 'animate__slow');

                return false;
            });

            button.addEventListener('click', (event) => {
                event.preventDefault();

                const input = $('#m');

                socket.emit('chat message', input.val());

                input.val('');

                button.disabled = true;

                element.classList.remove('animate__lightSpeedInLeft');
                element.classList.remove('animate__pulse', 'animate__infinite', 'animate__slow')
                element.classList.add('animate__pulse', 'animate__infinite', 'animate__slow');

                return false;
            });

            input.addEventListener('keypress', event => {
                if (event.key === 'Enter') {
                    event.preventDefault();

                    button.click();
                }
            });

            socket.on('disconnect user', (id) => {
                let toast = document.getElementById(`${id}`);

                iziToast.hide({
                    transitionOut: 'fadeOutDown'
                }, toast);

                toast = document.getElementById(`${socket.id}`);

                iziToast.hide({
                    transitionOut: 'fadeOutDown'
                }, toast);

                mediaRecorder.stop();
                connected = false;
            });

            worker.addEventListener('message', (event) => {
                const id = 'nonse';
                const popup = new Popup({
                    id,
                    ackgroundColor: "#bff7ff",
                    showImmediately: true,
                    sideMargin: "5%",
                    title: '',
                    fadeTime: ".7s",
                    css: `@import url('https://fonts.googleapis.com/css2?family=Roboto&display=swap');`,
                    content: `
                        <video muted id="remote-video-record-${id}" width="300"></video>
                    `,
                    hideCallback: () => {
                        console.dir(popup);
                    },
                    loadCallback: () => {
                        let video = document.getElementById(`remote-video-record-${id}`);

                        video.src=`${event.data}`;
                        video.controls = true;
                        video.play();
                    },
                });
            }, false);

            const configuration = {
                'iceServers': [
                    {
                        'urls': [
                            'stun:stun.l.google.com:19302',
                            // 'stun:stun1.l.google.com:19302',
                            // 'stun:stun2.l.google.com:19302',
                            // 'stun:stun3.l.google.com:19302',
                            // 'stun:stun4.l.google.com:19302',
                            // 'stun:stun01.sipphone.com',
                            // 'stun:stun.ekiga.net',
                            // 'stun:stun.fwdnet.net',
                            // 'stun:stun.ideasip.com',
                            // 'stun:stun.iptel.org',
                            // 'stun:stun.rixtelecom.se',
                            // 'stun:stun.schlund.de',
                            // 'stun:stunserver.org',
                            // 'stun:stun.softjoys.com',
                            // 'stun:stun.voiparound.com',
                            // 'stun:stun.voipbuster.com',
                            // 'stun:stun.voipstunt.com',
                            // 'stun:stun.voxgratia.org',
                            'stun:stun.xten.com'
                        ]
                    }
                ]
            };
            const rtcPeerConnection = new RTCPeerConnection(configuration);

            // rtcPeerConnection.addEventListener('icecandidate', () =>{});
            rtcPeerConnection.onicecandidate = event => {
                console.log('>>> onicecandidate');

                if (event.candidate) {
                    socket.emit('signal', { 'candidate': event.candidate });
                }
            };

            rtcPeerConnection.addEventListener('signalingstatechange', (event) => {
                console.log('!!! .. signalingstatechange');
                console.dir(event);
            });

            const collection = document.getElementsByClassName('iziToast');

            if(collection.length !== 0) {
                iziToast.destroy();
            }

            iziToast.show({
                id: socket.id,
                class: '',
                title: '',
                titleColor: '',
                titleSize: '',
                titleLineHeight: '',
                message: `
                            <video autoplay muted id="local-video" width="300">
                                <!--
                                <source src="//www.thomas-schulte.de/video/video2.mp4" type="video/mp4">
                                <source src="//www.thomas-schulte.de/video/video2.ogg" type="video/ogg">
                                -->
                                Your browser does not support the video tag.
                            </video>
                        `,
                messageColor: '',
                messageSize: '',
                messageLineHeight: '',
                backgroundColor: 'transparent',
                theme: null,
                color: '',
                icon: '',
                iconText: '',
                iconColor: '',
                iconUrl: null,
                image: '',
                imageWidth: 0,
                maxWidth: null,
                zindex: 10000001,
                layout: 1,
                balloon: false,
                close: false,
                closeOnEscape: false,
                closeOnClick: false,
                displayMode: 0,
                position: 'topRight',
                target: '',
                targetFirst: true,
                timeout: null,
                rtl: false,
                animateInside: true,
                drag: false,
                pauseOnHover: true,
                resetOnHover: false,
                progressBar: false,
                progressBarColor: '',
                progressBarEasing: 'linear',
                overlay: false,
                overlayClose: false,
                overlayColor: 'rgba(0, 0, 0, 0.6)',
                transitionIn: 'fadeInUp',
                transitionOut: 'fadeOut',
                transitionInMobile: 'fadeInUp',
                transitionOutMobile: 'fadeOutDown',
                buttons: {},
                inputs: {},
                onOpening: () => {},
                onOpened: (_element) => {
                    const localVideo = document.getElementById("local-video");
                    const constraints = {
                        video: {
                            width: true,
                            width: {
                                // min: 1024,
                                // ideal: 1280,
                                // max: 3840,
                                // exact: 1920
                            },
                            height: {
                                // min: 567,
                                // ideal: 720,
                                // max: 2160,
                                // exact: 1080
                            }
                        },
                        audio: true
                    };

                    if (navigator.mediaDevices.getUserMedia) {
                        navigator.mediaDevices.getUserMedia({video: true, audio: true})
                            .then((stream) => {
                                localVideo.srcObject = stream;

                                // ToDo: FFmpeg
                                // mediaRecorder = new MediaRecorder(stream);
                                //
                                // mediaRecorder.ondataavailable = event => {
                                //     if (event.data && event.data.size > 0) {
                                //         recordedBlobs.push(event.data);
                                //     }
                                // };
                                //
                                // mediaRecorder.start();

                                stream.getTracks().forEach(track => {
                                    //console.log(track);
                                    //console.log(track.getConstraints());
                                    //console.log(track.getCapabilities());
                                    //console.log(track.getSettings());

                                    if(track.kind === 'video') {
                                        track.applyConstraints({
                                            width: {
                                                exact: 300
                                            },
                                            height: {
                                                exact: 300
                                            }
                                        });
                                    }

                                    rtcPeerConnection.addTrack(track, stream);
                                });

                                rtcPeerConnection.createOffer()
                                    .then(async offer => {
                                        console.log('>>> offer');
                                        // console.dir(offer);

                                        await rtcPeerConnection.setLocalDescription(offer);

                                        return rtcPeerConnection.localDescription;
                                    })
                                    .then((sdp) => {
                                        console.log('>>> sdp');
                                        // console.dir(sdp);

                                        socket.emit('signal', { sdp });
                                    });
                            })
                            .catch((error) => {
                                console.error(error);
                            });
                    }
                },
                onClosing: () => {},
                onClosed: () => {}
            });

            socket.on('connect', () => {
                const socketId = socket.id;

                button.title = socketId;

                if(toast) {
                    toast.reset();
                }

                toast = $.toast({
                    text: `
                        <p>
                            ${socketId} <h3><b> 0 </b></h3>
                        </p>
                    `,
                    loader: false,
                    loaderBg: 'grey',
                    allowToastClose: true,
                    hideAfter: false,
                    position: 'top-left',
                    bgColor: '#ccc',
                    textColor: 'black',
                    textAlign: 'center',
                    beforeShow: () => {},
                    afterShown: () => {},
                    beforeHide: () => {},
                    afterHidden: () => {}
                });
            });

            console.log(navigator.mediaDevices.getSupportedConstraints());

            socket.on('new user', (newId, emit = true) => {
                if (newId !== socket.id) {


                    iziToast.show({
                        id: newId,
                        message: `
                            <video autoplay id="remote-video-${newId}" width="300">
                                Your browser does not support the video tag.
                            </video>
                        `,
                        color: 'grey',
                        layout: 1,
                        balloon: false,
                        close: false,
                        closeOnEscape: false,
                        closeOnClick: false,
                        displayMode: 0,
                        position: 'bottomRight',
                        target: '',
                        targetFirst: true,
                        timeout: null,
                        rtl: false,
                        animateInside: true,
                        drag: false,
                        pauseOnHover: true,
                        resetOnHover: false,
                        progressBar: false,
                        progressBarEasing: 'linear',
                        overlay: false,
                        overlayClose: false,
                        overlayColor: 'rgba(0, 0, 0, 0.6)',
                        transitionIn: 'fadeInUp',
                        transitionOut: 'fadeOut',
                        transitionInMobile: 'fadeInUp',
                        transitionOutMobile: 'fadeOutDown',
                        buttons: {},
                        inputs: {},
                        onOpening: () => {
                            const remoteVideo = document.getElementById(`remote-video-${newId}`);

                            if (navigator.mediaDevices.getUserMedia) {
                                rtcPeerConnection.ontrack = event => {
                                    const stream = event.streams[0];

                                    remoteVideo.srcObject = stream;

                                    mediaRecorder = new MediaRecorder(stream);

                                    mediaRecorder.addEventListener('dataavailable', event => {
                                        if (event.data && event.data.size > 0) {
                                            recordedBlobs.push(event.data);

                                            worker.postMessage(recordedBlobs);
                                        }

                                    });

                                    mediaRecorder.start();

                                    console.log("recorder started: " + mediaRecorder.state);
                                };
                            }
                        },
                        onOpened: (_element) => {
                            if (emit) {
                                socket.emit('update', {
                                    from: socket.id,
                                    to: newId
                                });
                            }

                            connected = true;
                        },
                        onClosing: () => {},
                        onClosed: () => {}
                    });
                }
            });

            socket.on('signal', data => {
                console.log('<<< . data');
                // console.dir(data);

                if (data.candidate) {
                    const rtcIceCandidate = new RTCIceCandidate(data.candidate);

                    console.log('<<< .. rtcIceCandidate');
                    // console.dir(rtcIceCandidate);

                    rtcPeerConnection.addIceCandidate(rtcIceCandidate);
                } else if (data.sdp) {
                    const sdp = new RTCSessionDescription(data.sdp);

                    rtcPeerConnection.setRemoteDescription(sdp).then(() => {
                        if (sdp.type === 'offer') {
                            rtcPeerConnection.createAnswer({}).then(async answer => {
                                await rtcPeerConnection.setLocalDescription(answer);

                                console.log('>>> answer');
                                console.dir(answer);

                                socket.emit('signal', {'sdp': answer});
                            });
                        } else if (sdp.type === 'answer') {
                            console.log('!!! answer');
                        }
                    });
                }
            });

            socket.on('users size', (size) => {
                const socketId = socket.id;

                toast.update({
                    text: `
                        <p>
                            ${socketId} <h3 class="animate__animated animate__flash animate__delay-1s"><b> ${size} </b></h3>
                        </p>
                    `,
                    beforeShow: () => {},
                    afterShown: () => {},
                    beforeHide: () => {},
                    afterHidden: () => {}
                });
            });

            socket.on('info user', (msg) => {
                $.toast({
                    text: `${msg}`,
                    icon: 'info',
                    loader: true,
                    loaderBg: 'grey',
                    showHideTransition: 'fade',
                    position: 'top-right',
                    hideAfter: 7000,
                    bgColor: 'grey',
                    textColor: 'white',
                    textAlign: 'left'
                });
            });

            socket.on('chat message', async (chat) => {
                const messages = $('#messages');
                const d = new Date();
                const mathRandom = Math.random();
                const msgUint8 = new TextEncoder().encode(chat.id);
                const hashBuffer = await crypto.subtle.digest("SHA-256", msgUint8);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const digestId = hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");

                messages.prepend($(`<li class="text-message animate__animated animate__flipInX">`).text('👤 ' + chat.msg));
                messages.prepend($(`<li class="info-text animate__animated animate__slideInDown" data-user-id="${digestId}">`).text(d.toDateString() + ' ⟡ ' + d.toLocaleTimeString() + ' |'));

                const measureText = context.measureText(chat.msg);
                const textWidth = measureText.width;
                const randomWidth = Math.floor(mathRandom * W);
                const randomHeight = Math.floor(mathRandom * H);
                const gray = Math.floor(Math.random() * 256);
                let hex = gray.toString(16);

                if (hex.length === 1) {
                    hex = '0' + hex;
                }

                context.fillStyle = '#' + hex + hex + hex;
                context.fillText(String(++counter), randomWidth, randomHeight, textWidth);

                sound.play();
            });

            input.addEventListener('input', (event) => {
                button.disabled = !event.data;
            });

            document.addEventListener('keydown', async (event) => {
                let mediaScreenRecorder;
                let captureStream;

                if (event.ctrlKey && event.key === 's') {
                    event.preventDefault();

                    const recordedScreenBlobs = [];
                    const displayMediaOptions = {
                        video: true,
                        audio: true,
                        surfaceSwitching: 'include'
                    };

                    try {
                        captureStream = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);
                        console.dir(captureStream);

                        mediaScreenRecorder = new MediaRecorder(captureStream);

                        mediaScreenRecorder.ondataavailable = event => {
                            if (event.data && event.data.size > 0) {
                                recordedScreenBlobs.push(event.data);

                                worker.postMessage(recordedScreenBlobs);
                            }
                        };

                        mediaScreenRecorder.start();

                        captureStream.getTracks().forEach(track => {
                            console.log(track);

                            track.onended = (event) => {
                                console.dir(event);

                                mediaScreenRecorder.stop();
                            };
                        });
                    } catch (err) {
                        console.error(err);
                    }
                } else if(event.ctrlKey && event.key === 'x' && connected) {
                    event.preventDefault();

                    let audioInput;
                    let audioOutput;
                    let videoInput;

                    try {
                        const devices = await navigator.mediaDevices.enumerateDevices();

                        $.toast({
                            text: `
                                <div style="padding: 5px;">
                                    <label for="audio-input">Select audio input:&nbsp;</label>
                                    <br>
                                    <select name="audio-input" id="audio-input" style="width:100%;"></select>
                                </div>
                                <hr>
                                <div style="padding: 5px;">
                                    <label for="audio-output">Select audio output:</label>
                                    <br>
                                    <select name="audio-output" id="audio-output" style="width:100%;"></select>
                                </div>
                                <hr>
                                <div style="padding: 5px;">
                                    <label for="video-input">Select video input:&nbsp;</label>
                                    <br>
                                    <select name="video-input" id="video-input" style="width:100%;"></select>
                                </div>
                            `,
                            heading: '',
                            icon: false,
                            showHideTransition: 'fade',
                            allowToastClose: true,
                            hideAfter: 30000,
                            textAlign: 'left',
                            loader: true,
                            loaderBg: 'grey',
                            bgColor: '#ccc',
                            textColor: 'black',
                            beforeShow: () => {
                                audioInput = document.querySelector('#audio-input');
                                audioOutput = document.querySelector('#audio-output');
                                videoInput = document.querySelector('#video-input');

                                devices.forEach(device => {
                                    console.log(device);
                                    const option = document.createElement('option');
                                    option.value = device.deviceId;
                                    option.text = device.label;

                                    if(device.kind === 'audioinput') {
                                        audioInput.appendChild(option);
                                    } else if(device.kind === 'audiooutput') {
                                        audioOutput.appendChild(option);
                                    } else if(device.kind === 'videoinput') {
                                        videoInput.appendChild(option);
                                    }
                                });
                            },
                            afterShown: (res) => {
                                console.dir(res);
                                const localVideo = document.getElementById("local-video");

                                audioInput.addEventListener('change', async (event) => {
                                    const deviceId = event.target.value;
                                    const constraints = {
                                        audio: {
                                            deviceId: {
                                                exact: deviceId
                                            }
                                        },
                                        video: true
                                    };

                                    const stream = await navigator.mediaDevices.getUserMedia(constraints);

                                    localVideo.srcObject = stream;

                                    const tracks = stream.getAudioTracks();

                                    console.dir(tracks);
                                });

                                audioOutput.addEventListener('change', async (event) => {
                                    const deviceId = event.target.value;

                                    await localVideo.setSinkId(deviceId);

                                    console.dir('Changed audio output device: ' + deviceId);
                                });

                                videoInput.addEventListener('change', async (event) => {
                                    const deviceId = event.target.value;
                                    const constraints = {
                                        video: {
                                            deviceId: {
                                                exact: deviceId
                                            }
                                        },
                                        audio: true
                                    };

                                    const stream = await navigator.mediaDevices.getUserMedia(constraints);

                                    localVideo.srcObject = stream;

                                    const tracks = stream.getVideoTracks();

                                    console.dir(tracks);
                                });
                            },
                            beforeHide: () => {},
                            afterHidden: () => {}
                        });
                    } catch (err) {
                        console.error(err);
                    }
                }
            });
        </script>
    </body>
</html>